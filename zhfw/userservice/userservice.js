define("userservice",["jquery","template","mustache","localStorage","map","leaflet","util"],function(G,c,g,l,j,h,b){var z=j.getMap();var t={},a={},S={};var v,P,K=false;var n=0.7;h.TileLayer.WmtsLayer=h.TileLayer.extend({getTileUrl:function(V){var M=this.options.url;var U=this.options.layerType;var T=this.options.style;var L=this.options.tileMatrixSet;var W=this.options.format;M=M+"?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER="+U+"&STYLE="+T+"&TILEMATRIXSET="+L+"&FORMAT="+W+"&TILECOL="+V.x+"&TILEROW="+V.y+"&TILEMATRIX="+V.z;return M}});h.tileLayer.wmtsLayer=function(L){return new h.TileLayer.WmtsLayer("",L)};function s(){if(G(".service_dialog").length>0){return}G("#app").append(c.service_add);G("#service_mask").show();G(".service_type .service").mouseover(function(){G("#service_type").show()}).mouseout(function(T){if(G.contains(this,T.toElement)){return}G("#service_type").hide()});function M(T){if(T=="wms"){G("#service_url").attr("placeholder","http://gisserver.tianditu.com/TDTService/region/wms")}else{if(T=="wmts"){G("#service_url").attr("placeholder","https://t0.tianditu.gov.cn/img_w/wmts")}}}G("#service_type li").click(function(){var T=G(this).attr("id");M(T);G(".service .service_name").text(G(this).text()).attr("name",T);G("#service_type").hide()});G("#service_url").focus(function(){G("#service_url").attr("placeholder","");G(".validate_info").hide()}).blur(function(){var T=G(".service .service_name").attr("name");M(T)});G("#service_ok").click(function(){if(K){return}var T=G.trim(G("#service_url").val());if(T==""){G(".validate_info .alert_text").text("服务地址不能为空");G(".validate_info").show();return}else{G(".validate_info").hide()}w(T)});function L(){if(K&&P){P.abort()}G(".service_dialog").remove();G("#service_mask").hide()}G("#service_cancel").click(L);G(".service_close").click(L)}function C(){O()}function I(M,L){P=G.ajax({url:"./zhfw/layerSearch",type:"POST",dataType:"json",contentType:"application/json",beforeSend:function(){G(".service_loading").show();K=true;G("#service_ok").css({background:"#ccc",border:"1px solid #ccc"})},data:JSON.stringify({postUrl:M,serviceType:L}),success:function(T){if(T.error){y()}else{H();F(T)}},complete:function(U,T){G(".service_loading").hide();K=false;G("#service_ok").css({background:"#5193e8",border:"1px solid #5193e8"});if(T=="timeout"){P.abort();y()}else{if(T=="500"){y()}}}})}function F(W){var X=W.layerInfos;var T=l.get("layerInfos");var L,U=true;if(T){T=JSON.parse(T);for(var Z in X){var V=X[Z];var Y=false;for(var M in T){if(T[M].layerName==V.layerName){Y=true;break}}if(!Y){if(U){L=x(V.layerName);U=false}T.push(X[Z])}}}else{T=X;L=x(X[0].layerName)}l.set("layerInfos",JSON.stringify(T));if(T&&T.length!=0){O();if(G(".left-down").is(":hidden")){G("#menu_display").trigger("click")}if(G(".classify-content").is(":hidden")){G(".classify .special").trigger("click")}if(G("#userlayer_000000 .ul-leaf").length==0||G("#userlayer_000000 .ul-leaf").is(":hidden")){G("#userlayer_000000").trigger("click")}G("#layer_"+L).find(".checkbox").trigger("click")}else{y()}}function x(L){return L.replace(/\s|:|%|\./g,"T")}function O(){var T=l.get("layerInfos")?JSON.parse(l.get("layerInfos")):[];if(T.length==0){return}if(G("#userlayer_000000").length==0){var L=[],M;M={code:"000000",name:"用户图层"};L.push(M);D("user_layers_root",L,".classify-children");G("#userlayer_000000 .ul-leaf").hide()}G("#userlayer_000000").off("click").on("click",function(){G("#userlayer_000000 .ul-leaf").toggle();var U=G(this).find(".triangle-down");if(U.css("transform")=="none"){U.css("transform","rotate(180deg)");G(this).addClass("active")}else{U.css("transform","");if(G(this).find(".ischecked").length==0){G(this).removeClass("active")}}});o(T)}function o(ab){var W=[],V;for(var ac in ab){var X=ab[ac];var Y=x(X.layerName);if(G("#layer_"+Y).length==0){var M=X.title;var Z=0,L=false;for(var U=0;U<M.length;U++){var T=M.charAt(U);if(m(T)){Z=Z+2;L=true}else{Z=Z+1}}if(L){Z=Math.floor(Z/2);if(Z>9){M=X.title.substr(0,9)+"..."}}else{if(Z>21){M=X.title.substr(0,21)+"..."}}V={code:Y,name:M,title:X.title};W.push(V)}}D("user_layers_leaf",W,"#userlayer_000000 .ul-leaf");for(var aa in W){G("#layer_"+W[aa].code).off("click").on("click",function(ae){var ad=G(ae.target);if(ad.is(".checkbox")){d(G(this))}else{if(ad.is(".help")){q(G(this))}}ae.stopPropagation();return false}).on("mouseover",f).on("mouseout",p)}G(".clear-all").off("click").on("click",function(){G(".layer-custom").remove();G(".ischecked").find(".checkbox").trigger("click")})}function f(Z){v=false;var L=G(this).attr("id").split("_");L.splice(0,1);var M=L.join("_");var T=J(M);var X=G(this).get(0);G(".subject-brief").remove();var V=b.getElementDistance(X,{x:241});var W;if(T.org){W="<p>"+T.org+"</p>"}else{W="暂无"}if(!T.dataTime){T.dataTime="暂无"}if(!T.abstracts){T.introduce="暂无"}else{T.introduce=T.abstracts}T.name=T.title;var Y=c.brief;var U=g.render(Y,{cur:T,datafrom:W});G("#app").append(U);if(G(".subject-brief").height()+V.top>G(window).height()-30){V.top=V.top-G(".subject-brief").height()}G(".subject-brief").css({left:V.left,top:V.top}).on("mouseover",function(){v=false}).on("mouseout",function(aa){v=true;setTimeout(function(){if(!G.contains(this,aa.toElement)&&v){G(".subject-brief").remove()}},300)})}function p(L){v=true;setTimeout(function(){if(!G.contains(this,L.toElement)&&v){G(".subject-brief").remove()}},500)}function d(T){T.toggleClass("ischecked");var L=T.attr("id").split("_");L.splice(0,1);var M=L.join("_");if(T.hasClass("ischecked")){k(M);E(M);Q()}else{r(M)}}function q(W){G("#app .layer-custom").remove();var V={edit:[{code:"opacity-edit",name:"透明度"},{code:"up-edit",name:"上移"},{code:"down-edit",name:"下移"},{code:"remove-layer",name:"删除图层"},{code:"metadata",name:"元数据"}]};var U=g.render(c.layer_custom,V);G("#app").append(U);var L=b.getElementDistance(W.find(".help").get(0),{x:35});var M=W.attr("id").split("_");M.splice(0,1);var T=M.join("_");$layerCustom=G("#app .layer-custom");$layerCustom.css({left:L.left,top:L.top});$layerCustom.on("click",function(X){G(this).remove();var Y=X.target;if(Y.className=="remove-layer"){R(T)}else{if(Y.className=="opacity-edit"){i(L,T)}else{if(Y.className=="up-edit"){u(T)}else{if(Y.className=="down-edit"){N(T)}else{if(Y.className=="metadata"){B(T)}}}}}})}function R(L){G("#app .layer-custom").remove();G("#layer_"+L).remove();if(G("#userlayer_000000 .ul-leaf").children().length==0){G("#userlayer_000000").remove()}if(t[L]){z.removeLayer(t[L]);t[L]=undefined}A(L)}function i(L,M){G("#app .opacity-custom").remove();var T=g.render(c.opacity_custom,{});G("#app").append(T);G("#app .opacity-custom").css({left:L.left,top:L.top});require(["slider"],function(U){G("#opacity_txt").val(a[M]*100?a[M]*100:n*100);new U.SlideBar({targetId:"opacity-bar",sliderCss:"imageSlider",sliderFillCss:"imageSliderFill",barCss:"imageBar",min:1,max:100,hints:"透明度",inputId:"opacity_txt",callback:function(V){a[M]=(V/100).toFixed(2);if(G("#layer_"+M).hasClass("ischecked")){t[M].setOpacity(a[M])}}})});G(".opacity-custom .close").on("click",function(){G("#app").children(".opacity-custom").remove()})}function u(L){G("#layer_"+L).insertBefore(G("#layer_"+L).prev());Q()}function N(L){G("#layer_"+L).insertAfter(G("#layer_"+L).next());Q()}function Q(){var M=G("#userlayer_000000 .ul-leaf").children();var L=M.length;M.each(function(V,X){var U=G(X).attr("id").split("_");U.splice(0,1);var W=U.join("_");S[W]=L-V});for(var T in t){if(t[T]){t[T].setZIndex(S[T])}}}function B(L){var M=J(L);window.open(M.url,"_blank")}function k(T){var V=J(T);var U,M=e(V.url);if(V.serviceType=="wms"){U=h.tileLayer.wms(M,{layers:V.layerName,format:V.format,transparent:true})}else{if(V.serviceType=="wmts"){U=h.tileLayer.wmtsLayer({url:M,layerType:V.layerName,style:V.style,tileMatrixSet:V.tileMatrixSet,format:V.format})}}z.addLayer(U);var Z=parseFloat(V.minx);var Y=parseFloat(V.miny);var X=parseFloat(V.maxx);var W=parseFloat(V.maxy);if(Z!=0&&Y!=0&&X!=0&&W!=0){var L=h.latLngBounds(h.latLng(Z,Y),h.latLng(X,W));z.fitBounds(L)}t[T]=U;if(a[T]){U.setOpacity(a[T])}else{U.setOpacity(n)}}function E(L){var M=J(L);if(M.legendUrl){G("#layer_"+L).find(".lv2-info").html('<img src="'+M.legendUrl+'"/>')}}function r(L){z.removeLayer(t[L]);t[L]=undefined}function e(M){var L=M.indexOf("?");if(L==-1){return M}else{return M.substr(0,L)}}function J(M){var U={};var T=JSON.parse(l.get("layerInfos"));for(var L in T){if(x(T[L].layerName)==M){U=T[L];break}}return U}function A(M){var T=JSON.parse(l.get("layerInfos"));for(var L in T){if(x(T[L].layerName)==M){T.splice(L,1);break}}l.set("layerInfos",JSON.stringify(T))}function D(U,M,L){var T=c[U];g.parse(T);var V=g.render(T,{subjects:M});G(L).prepend(V)}function w(T){var M=G(".service .service_name").attr("name");var L;if(M=="wms"){L="wms"}else{if(M=="wmts"){L="wmts"}}T=T+"?service="+L+"&request=GetCapabilities";I(T,L)}function y(){var T=G(".service .service_name").attr("name");var X=G.trim(G("#service_url").val());var V=T.toUpperCase()+"服务"+X+"无法添加到地图，请检查网络或者服务地址是否正确！";G(".service_dialog").hide();if(G("#popup_container").length>0){G("#popup_container").remove()}var M=c.alert_popup;g.parse(M);var Y=g.render(M,{content:V});G("#app").append(Y);function W(){G("#popup_container").remove();G(".service_dialog").show()}G("#popup_ok").click(W);G(".popup_close").click(W);var L=G("#popup_container").width();var U=G("#popup_container").height();G("#popup_container").css({"margin-left":-L/2+"px","margin-top":-U/2+"px"})}function H(){G(".service_dialog").remove();G("#service_mask").hide();G("#popup_container").remove()}function m(M){var L=/[\u4E00-\u9FA5\uF900-\uFA2D]/;return L.test(M)}return{serviceDialog:s,loadUserLayers:C}});